{% extends "base.html" %} {% block title %}Term Report - {{ student.full_name
}}{% endblock %} {% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
  <!-- Header -->
  <div class="bg-white rounded-xl shadow-md p-6 mb-6">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Term Report</h1>
        <p class="text-gray-600">{{ term }} {{ year }}</p>
        <h2 class="text-xl font-semibold mt-2">{{ student.full_name }}</h2>
        <p class="text-gray-600">
          {% if class_ %} {{ class_.name }} â€¢ {{ class_.level }} {{
          class_.section }} {% else %} No class assigned {% endif %}
        </p>
      </div>
      <div class="text-right">
        <p class="text-sm text-gray-500">
          Generated on: {{ now.strftime('%Y-%m-%d') }}
        </p>
      </div>
    </div>
  </div>

  <!-- Grades Table -->
  <div class="bg-white rounded-xl shadow-md overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Subject
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Class Score
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Exam Score
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Total Score
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Grade
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Position
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for score in term_scores %}
        <tr>
          <td
            class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
          >
            {{ score.subject.name if score.subject else "N/A" }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            {{ score.class_total | round(2) }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            {{ score.exam_score | round(2) }}
          </td>
          <td
            class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
          >
            {{ score.total_score | round(2) }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            {% if score.total_score >= 80 %}A{% elif score.total_score >= 70
            %}B{% elif score.total_score >= 60 %}C{% elif score.total_score >=
            50 %}D{% else %}F{% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            {{ subject_positions.get(score.subject_id, "N/A") }}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
            No grades available for this term.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Summary -->
  <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white rounded-xl shadow-md p-4">
      <h3 class="text-sm font-medium text-gray-500">Average Score</h3>
      <p class="text-2xl font-bold text-gray-800">
        {% set total_scores = term_scores | map(attribute='total_score') | list
        %} {% if total_scores %} {{ (total_scores | sum / total_scores | length)
        | round(2) }} {% else %} N/A {% endif %}
      </p>
    </div>
    <div class="bg-white rounded-xl shadow-md p-4">
      <h3 class="text-sm font-medium text-gray-500">Best Subject</h3>
      <p class="text-xl font-bold text-gray-800">
        {% if term_scores %} {% set best_subject = term_scores |
        max(attribute='total_score') %} {{ best_subject.subject.name if
        best_subject.subject else "N/A" }} ({{ best_subject.total_score |
        round(2) }}) {% else %} N/A {% endif %}
      </p>
    </div>
    <div class="bg-white rounded-xl shadow-md p-4">
      <h3 class="text-sm font-medium text-gray-500">Overall Position</h3>
      <p class="text-2xl font-bold text-gray-800">
        {% if term_scores and class_ %} {% set class_students =
        Student.query.filter_by(class_id=class_.id).all() %} {% set student_ids
        = class_students | map(attribute='id') | list %} {% set student_totals =
        {} %} {% for student_id in student_ids %} {% set scores =
        TermScore.query.filter_by(student_id=student_id, term=term,
        year=year).all() %} {% set total = scores | map(attribute='total_score')
        | sum %} {% set _ = student_totals.update({student_id: total}) %} {%
        endfor %} {% set sorted_totals = student_totals.items() |
        sort(attribute='1', reverse=True) %} {% for rank, (s_id, total) in
        enumerate(sorted_totals, 1) %} {% if s_id == student.id %} {{ rank }}/{{
        student_totals | length }} {% endif %} {% endfor %} {% else %} N/A {%
        endif %}
      </p>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="mt-6 flex justify-end space-x-4">
    <a
      href="{{ url_for('exams_grading.class_term_reports', class_id=class_.id, term=term, year=year) if class_ else '#' }}"
      class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700"
    >
      Back to Class Reports
    </a>
    <button
      onclick="window.print()"
      class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
    >
      Print Report
    </button>
  </div>
</div>
{% endblock %}
